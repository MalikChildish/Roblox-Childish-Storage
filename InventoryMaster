-- InventoryMaster.lua
-- Malik Allen LLC, Roblox Studio Pro GPT

local MasterFolder = game.ReplicatedStorage.InventorySystem
local DropBoxPrefab = MasterFolder.Prefab.DroppedBox

-- Services
local Debris = game:GetService("Debris")
local DataStoreService = game:GetService("DataStoreService")
local PlayerDataStore = DataStoreService:GetDataStore("PlayerData")

-- Events
local Events = MasterFolder.Events
local UpdateUIEvent = Events.ServerClient.UpdateUI
local CollectBoxEvent = Events.ServerServer.CollectBox
local DropItemsEvent = Events.ClientServer.DropItem
local AddItemsEvent = Events.ServerServer.AddItems
local EquipItemsEvent = Events.ClientServer.EquipItem
local UnequipItemsEvent = Events.ClientServer.UnequipItem
local SelectToolBarEvent = Events.ClientServer.SelectToolBarSlot
local AddToToolBarEvent = Events.ClientServer.AddToToolBar
local UnequipToolBarEvent = Events.ClientServer.UnequipToolBar

local RequestDataEvent = game.ReplicatedStorage.PlayerDataSystem.Events.ServerServer.RequestPlayerData
local ModifyDataEvent = game.ReplicatedStorage.PlayerDataSystem.Events.ServerServer.ModifyPlayerData

local MessageEvent = game.ReplicatedStorage.NotificationSystem.Events.ServerClient.SendMessage

-- Modules
local ItemDB = require(MasterFolder.Modules.ItemData)

-- Static
local DroppedItemDestroyTime = 120
local MaxToolBarSlots = 9

function AddItem(Player:Player, ItemName, Amount, CheckForSpace, PreDefinedInventory, DoAnnounce)
	local PlayerInventory = PreDefinedInventory or RequestDataEvent:Invoke(Player, "Inventory")
	local PlayerBagSpace = Player:GetAttribute("BagSpace")

	if not ItemDB.Items[ItemName] then
		MessageEvent:FireClient(Player, "Unknown Item!", Color3.new(1, 0, 0), 2)
		return false
	end

	if CheckForSpace and #PlayerInventory + Amount >= PlayerBagSpace then
		MessageEvent:FireClient(Player, "Not Enough Bag Space!", Color3.new(1, 0, 0), 2)
		return false
	end

	local CommandsTable = table.create(Amount, "ADD")
	local KeyWordsTable = table.create(Amount, "Inventory")
	local ItemsTable = table.create(Amount, ItemName)

	ModifyDataEvent:Invoke(Player, CommandsTable, KeyWordsTable, ItemsTable)

	if DoAnnounce == true then
		MessageEvent:FireClient(Player, Added x{Amount} {ItemName}s, Color3.new(1, 0.74902, 0), 2)
	end
	UpdateUIEvent:FireClient(Player, RequestDataEvent:Invoke(Player, "Inventory"))
end
AddItemsEvent.Event:Connect(AddItem)

function GetAmount(Inventory, ItemName)
	local Count = 0
	for _, Item in ipairs(Inventory) do
		if Item == ItemName then
			Count += 1
		end
	end
	return Count
end

function DropItem(Player:Player, ItemName, Amount)
	if not ItemDB.Items[ItemName] then
		MessageEvent:FireClient(Player, "Unknown Item!", Color3.new(1, 0, 0), 2)
		return false
	end

	local PlayerInventory = RequestDataEvent:Invoke(Player, "Inventory")

	if GetAmount(PlayerInventory, ItemName) < Amount then
		MessageEvent:FireClient(Player, "Not Enough Items!", Color3.new(1, 0, 0), 2)
		return
	end

	local PlayerCharacter = Player.Character

	if not PlayerCharacter then
		MessageEvent:FireClient(Player, "You Need To Be Alive To Drop Items!", Color3.new(1, 0, 0), 2)
		return
	end
	local Removed = 0

	pcall(function()
		while Removed < Amount do
			if not Player then return end
			for i, Item in ipairs(PlayerInventory) do
				if Item == ItemName then
					Removed += 1
					table.remove(PlayerInventory, i)
					break
				end
			end
		end
	end)

	ModifyDataEvent:Invoke(Player, "UPDATE", "Inventory", PlayerInventory)

	local NewBox = DropBoxPrefab:Clone()
	NewBox:SetAttribute("ItemName", ItemName)
	NewBox:SetAttribute("Amount", Amount)
	NewBox.Display.ItemImage.Image = ItemDB.Items[ItemName]["Image"]
	NewBox.Display.AmountLabel.Text = x{Amount}

	local ParentFolder = workspace:FindFirstChild("DroppedItems")
	if not ParentFolder then
		ParentFolder = Instance.new("Folder", workspace)
		ParentFolder.Name = "DroppedItems"
	end
	NewBox.Parent = ParentFolder

	Debris:AddItem(NewBox, DroppedItemDestroyTime)

	NewBox:PivotTo(PlayerCharacter:GetPivot() * CFrame.new(3, 0, 0))
	MessageEvent:FireClient(Player, Dropped x{Amount} {ItemName}s!, Color3.new(1, 0, 0.0156863), 5)
	UpdateUIEvent:FireClient(Player, RequestDataEvent:Invoke(Player, "Inventory"))
	UpdateToolBar(Player, ItemName)
end
DropItemsEvent.OnServerEvent:Connect(DropItem)

function CollectBox(Player:Player, Box:Part)
	local PlayerInventory = RequestDataEvent:Invoke(Player, "Inventory")
	local PlayerBagSpace = Player:GetAttribute("BagSpace")

	local FreeSpace = PlayerBagSpace - #PlayerInventory

	if FreeSpace <= 0 then
		MessageEvent:FireClient(Player, "Not Enough Bag Space!", Color3.new(1, 0, 0), 2)
		return
	end

	local BoxAmount = Box:GetAttribute("Amount") or 0
	local BoxItemName = Box:GetAttribute("ItemName")

	if FreeSpace >= BoxAmount then
		Box:Destroy()
		AddItem(Player, BoxItemName, BoxAmount, true, PlayerInventory, false)
		MessageEvent:FireClient(Player, Collected x{BoxAmount} {BoxItemName}s From A Box!, Color3.new(1, 0.74902, 0), 2)
	else
		Box:SetAttribute("Amount", BoxAmount - FreeSpace)
		AddItem(Player, BoxItemName, FreeSpace, true, PlayerInventory, false)
		MessageEvent:FireClient(Player, Collected x{FreeSpace} {BoxItemName}s From A Box!, Color3.new(1, 0.74902, 0), 2)
	end
end
CollectBoxEvent.Event:Connect(CollectBox)

function ConsumeItem(Player:Player, ItemName, PlayerInventory)
	local ItemInfo = ItemDB.Items[ItemName]
	local Character = Player.Character
	if not Character or not Character:FindFirstChild("Humanoid") then return end
	local Humanoid:Humanoid = Character:FindFirstChild("Humanoid")

	-- Handle Food consumption
	if ItemInfo["Type"] == "Food" then
		local HealthValue = ItemInfo["HealthAmount"]
		if Humanoid.Health == Humanoid.MaxHealth then
			MessageEvent:FireClient(Player, "Your Health Is Already Full!", Color3.new(1, 0, 0), 2)
			return
		end
		Humanoid.Health += HealthValue
		MessageEvent:FireClient(Player, Consumed {ItemName}! +{HealthValue} Health, Color3.new(0.101961, 1, 0), 5)

		-- Handle Drink consumption with Speed Boost
	elseif ItemInfo["Type"] == "Drink" then
		local SpeedBoost = ItemInfo["SpeedBoost"]
		local Duration = ItemInfo["EffectDuration"]

		-- Check if player already has a speed boost active
		if Player:GetAttribute("HasSpeedBoost") then
			MessageEvent:FireClient(Player, "You already have a speed boost active!", Color3.new(1, 0, 0), 5)
			return
		end

		-- Apply speed boost and set the HasSpeedBoost attribute
		Player:SetAttribute("HasSpeedBoost", true)
		Humanoid.WalkSpeed += SpeedBoost
		MessageEvent:FireClient(Player, Consumed {ItemName}! +{SpeedBoost} Speed for {Duration} seconds, Color3.new(0.101961, 1, 0), 5)

		-- Schedule removal of speed boost and reset the HasSpeedBoost attribute
		task.delay(Duration, function()
			if Humanoid then
				Humanoid.WalkSpeed -= SpeedBoost
				Player:SetAttribute("HasSpeedBoost", false)
				MessageEvent:FireClient(Player, "Speed boost has worn off!", Color3.new(1, 0, 0), 5)
			end
		end)
	end

	-- Remove the item from inventory after consumption
	table.remove(PlayerInventory, table.find(PlayerInventory, ItemName))
	ModifyDataEvent:Invoke(Player, "REMOVE", "Inventory", ItemName)
	UpdateUIEvent:FireClient(Player, PlayerInventory)
end

function EquipItem(Player:Player, ItemName)
	local PlayerInventory = RequestDataEvent:Invoke(Player, "Inventory")
	if GetAmount(PlayerInventory, ItemName) <= 0 then
		MessageEvent:FireClient(Player, "You Don't Have That Item!", Color3.new(1, 0, 0), 2)
		return
	end

	local ItemInfo = ItemDB.Items[ItemName]

	if not ItemInfo then
		MessageEvent:FireClient(Player, "Unknown Item!", Color3.new(1, 0, 0), 2)
		return false
	end

	if ItemInfo["Type"] == "Food" or ItemInfo["Type"] == "Drink" then
		ConsumeItem(Player, ItemName, PlayerInventory)
		return
	elseif ItemInfo["Type"] ~= "Wearable" then
		MessageEvent:FireClient(Player, "You Can't Equip This Item!", Color3.new(1, 0, 0), 2)
		return
	end

	local ItemSlot = ItemInfo["Slot"]

	local CurrentItem = Player:GetAttribute(string.format("%sItem", ItemSlot))

	if CurrentItem == ItemName then
		MessageEvent:FireClient(Player, "Already Equipped!", Color3.new(1, 0, 0), 2)
		return
	end

	for i, Item in ipairs(PlayerInventory) do
		if Item == ItemName then
			table.remove(PlayerInventory, i)
			break
		end
	end

	if CurrentItem ~= "" or not CurrentItem then
		table.insert(PlayerInventory, CurrentItem)
	end
	ModifyDataEvent:Invoke(Player, {"UPDATE", "UPDATE"}, {"Inventory", string.format("%sItem", ItemSlot)}, {PlayerInventory, ItemName})
	UpdateUIEvent:FireClient(Player, RequestDataEvent:Invoke(Player, "Inventory"))
	MessageEvent:FireClient(Player, string.format("Equipped %s!", ItemName), Color3.new(1, 0.74902, 0), 3)
	UpdateToolBar(Player, ItemName)
end
EquipItemsEvent.OnServerEvent:Connect(EquipItem)

function UnequipItem(Player:Player, Slot)
	local CurrentItem = Player:GetAttribute(string.format("%sItem", Slot))
	if not CurrentItem or CurrentItem == "" then
		MessageEvent:FireClient(Player, "Nothing To Unequip!", Color3.new(1, 0, 0), 2)
		return
	end

	local PlayerInventory = RequestDataEvent:Invoke(Player, "Inventory")
	local PlayerBagSpace = Player:GetAttribute("BagSpace")

	if #PlayerInventory >= PlayerBagSpace then
		MessageEvent:FireClient(Player, "Not Enough Space In Your Bag To Unequip This!", Color3.new(1, 0, 0), 2)
		return
	end

	ModifyDataEvent:Invoke(Player, {"ADD", "UPDATE"}, {"Inventory", string.format("%sItem", Slot)}, {CurrentItem, ""})
	UpdateUIEvent:FireClient(Player, RequestDataEvent:Invoke(Player, "Inventory"))
	MessageEvent:FireClient(Player, string.format("Unequipped %s!", CurrentItem), Color3.new(1, 0.74902, 0), 3)
	UpdateToolBar(Player, CurrentItem)
end
UnequipItemsEvent.OnServerEvent:Connect(UnequipItem)

function SelectedToolBarChange(Player:Player, Ind)
	local CurrentInd = Player:GetAttribute("SelectedToolBarSlot")
	if CurrentInd == Ind then
		return
	end

	ModifyDataEvent:Invoke(Player, "UPDATE", "SelectedToolBarSlot", Ind)
end
SelectToolBarEvent.OnServerEvent:Connect(SelectedToolBarChange)

function UpdateToolBar(Player:Player, RemovedItem)
	for i = 1, MaxToolBarSlots do
		if Player:GetAttribute(string.format("ToolBar%d", i)) == RemovedItem then
			ModifyDataEvent:Invoke(Player, "UPDATE", string.format("ToolBar%d", i), "")
		end
	end
end

function AddToToolBar(Player:Player, CurrentItem, ToSlot)
	if not CurrentItem or CurrentItem == "" then return end

	if Player:GetAttribute(string.format("ToolBar%d", ToSlot)) == CurrentItem then
		MessageEvent:FireClient(Player, "Already Equipped!", Color3.new(1, 0, 0), 2)
		return
	end

	local ItemInfo = ItemDB.Items[CurrentItem]
	if not ItemInfo then return end

	ModifyDataEvent:Invoke(Player, "UPDATE", string.format("ToolBar%d", ToSlot), CurrentItem)
end
AddToToolBarEvent.OnServerEvent:Connect(AddToToolBar)

UnequipToolBarEvent.OnServerEvent:Connect(function(player, slotName)
	local currentItem = player:GetAttribute("ToolBar" .. slotName)
	if currentItem and currentItem ~= "" then
		local PlayerInventory = RequestDataEvent:Invoke(player, "Inventory")
		local PlayerBagSpace = player:GetAttribute("BagSpace")

		if #PlayerInventory >= PlayerBagSpace then
			MessageEvent:FireClient(player, "Not Enough Space In Your Bag To Unequip This!", Color3.new(1, 0, 0), 2)
			return
		end

		table.insert(PlayerInventory, currentItem)
		ModifyDataEvent:Invoke(player, {"UPDATE", "ADD"}, {"ToolBar" .. slotName, "Inventory"}, {"", currentItem})
		UpdateUIEvent:FireClient(player, RequestDataEvent:Invoke(player, "Inventory"))
	end
end)

game.Players.PlayerAdded:Connect(function(player)
	local data
	local success, err = pcall(function()
		data = PlayerDataStore:GetAsync(player.UserId)
	end)

	if success and data then
		-- Load player data
		for i = 1, MaxToolBarSlots do
			player:SetAttribute("ToolBar" .. i, data["ToolBar" .. i] or "")
		end
		player:SetAttribute("SelectedToolBarSlot", data.SelectedToolBarSlot or 1)
	else
		warn("Failed to load data for player: " .. err)
		-- Initialize toolbar slots with default values if data doesn't exist
		for i = 1, MaxToolBarSlots do
			player:SetAttribute("ToolBar" .. i, "")
		end
		player:SetAttribute("SelectedToolBarSlot", 1)
	end
end)

game.Players.PlayerRemoving:Connect(function(player)
	local data = {}
	for i = 1, MaxToolBarSlots do
		data["ToolBar" .. i] = player:GetAttribute("ToolBar" .. i)
	end
	data.SelectedToolBarSlot = player:GetAttribute("SelectedToolBarSlot")

	local success, err = pcall(function()
		PlayerDataStore:SetAsync(player.UserId, data)
	end)

	if not success then
		warn("Failed to save data for player: " .. err)
	end
end)

Inventory Controller: 
-- InventoryController.lua
-- Malik Allen LLC, Roblox Studio Pro GPT

local Player = game.Players.LocalPlayer

local MasterFolder = game.ReplicatedStorage.InventorySystem
local InventorySlots = script.Parent.InventorySlots
local NextArrow = script.Parent.NextArrow
local PreviousArrow = script.Parent.PreviousArrow
local PageIndicator = script.Parent.PageIndicator
local SpaceCount = script.Parent.SpaceCount

local ToolBar = script.Parent.Parent.Parent:WaitForChild("ToolBar"):WaitForChild("ToolBarHolder")
local ToolBarSlots = ToolBar.Slots
local ToolBarSelectionStroke = ToolBar.SelectionStroke

local EquipmentPanel = script.Parent.EquipmentPanel
local EquipmentSlots = EquipmentPanel.Slots

local InfoPanel = script.Parent.InfoPanel
local InfoToolBarButtons = InfoPanel.ToolBarButtons
local InfoDropButton = InfoPanel.DropButton
local InfoEquipButton = InfoPanel.EquipButton
local InfoDescription = InfoPanel.Description
local InfoItemName = InfoPanel.ItemName

-- Modules
local ItemDB = require(MasterFolder.Modules.ItemData)

-- Events
local Events = MasterFolder.Events
local UpdateUIEvent = Events.ServerClient.UpdateUI
local LoadPlayerDataEvent = game.ReplicatedStorage.PlayerDataSystem.Events.ServerClient.LoadData
local DropItemsEvent = Events.ClientServer.DropItem
local EquipItemEvent = Events.ClientServer.EquipItem
local UnequipItemEvent = Events.ClientServer.UnequipItem
local SelectToolBarEvent = Events.ClientServer.SelectToolBarSlot
local AddToToolBarEvent = Events.ClientServer.AddToToolBar
local UnequipToolBarEvent = Events.ClientServer.UnequipToolBar

-- Static
local SlotCount = 9

-- Tracking
local CurrentInventoryItems = {}
local CurrentPages = {}
local CurrentSelectedPage = 1
local CurrentSelectedItem = nil
local CurrentSelectedToolBarSlot = 1

function GetPages(Items)
	local Pages = {}
	local CurrentPage = 1
	for i, Item in ipairs(Items) do
		if not Pages[CurrentPage] then Pages[CurrentPage] = {} end

		if #Pages[CurrentPage] < SlotCount then
			table.insert(Pages[CurrentPage], Item)
		end

		if #Pages[CurrentPage] >= SlotCount then
			CurrentPage += 1
		end
	end

	print(Pages)
	return Pages
end

function UpdateSpaceCount()
	local PlayerBagSpace = Player:GetAttribute("BagSpace") or 0
	SpaceCount.Text = string.format("%d / %d", #CurrentInventoryItems, PlayerBagSpace)
end

Player:GetAttributeChangedSignal("BagSpace"):Connect(UpdateSpaceCount)

function SelectPage(PageNumber)
	local Page = CurrentPages[PageNumber] or {}

	for i, Item in ipairs(InventorySlots:GetChildren()) do
		Item:SetAttribute("CurrentItem", nil)
		Item.Image = ""
		Item.ImageColor3 = Color3.new(1, 1, 1)

		local PageItem = Page[i]
		if not PageItem then continue end

		local ItemInfo = ItemDB.Items[PageItem]
		if not ItemInfo then continue end

		Item:SetAttribute("CurrentItem", PageItem)
		Item.Image = ItemInfo["Image"]
	end
	CurrentSelectedPage = PageNumber
	PageIndicator.Text = string.format("Page %d Of %d", PageNumber, #CurrentPages)
end

function MoveToPage(ByValue)
	local TargetNumber = CurrentSelectedPage + ByValue
	if CurrentPages[TargetNumber] then
		SelectPage(TargetNumber)
		UpdateInfoPanel(CurrentSelectedItem)
	end
end

function UpdateItems(Items)
	CurrentInventoryItems = Items
	CurrentPages = GetPages(Items)
	SelectPage(1)
	UpdateSpaceCount()
	UpdateInfoPanel(CurrentSelectedItem)
end

function UpdateInfoPanel(Item)
	if CurrentSelectedItem then
		CurrentSelectedItem.ImageColor3 = Color3.new(1, 1, 1)
	end

	CurrentSelectedItem = Item

	if CurrentSelectedItem then
		CurrentSelectedItem.ImageColor3 = Color3.new(1, 0, 0.0156863)
	end

	local ItemName = (CurrentSelectedItem and CurrentSelectedItem:GetAttribute("CurrentItem")) or nil

	if not ItemName then
		InfoPanel.Visible = false
		return
	end

	InfoPanel.Visible = true
	local ItemInfo = ItemDB.Items[ItemName]

	for _, ToolBarButton in ipairs(InfoToolBarButtons:GetChildren()) do
		ToolBarButton.Visible = (ItemInfo["Type"] == "Tool")
	end

	InfoDropButton.Visible = (ItemInfo["IsDropable"] == true)
	InfoEquipButton.Visible = (ItemInfo["Type"] == "Wearable") or (ItemInfo["Type"] == "Food") or (ItemInfo["Type"] == "Drink")
	InfoEquipButton.Text = ItemDB.TypeInfo[ItemInfo["Type"]].ActionText

	InfoDescription.Text = string.format("%s", ItemInfo["Description"])

	if ItemInfo["Type"] == "Wearable" then
		InfoDescription.Text = string.format("<i>%s</i> <b> <br /> <font color='rgb(255,0,0)'> Health : %d</font> <br /> <font color='rgb(0,0,255)'> Speed : %d</font></b>", ItemInfo["Description"], ItemInfo["Health"], ItemInfo["Speed"])
	elseif ItemInfo["Type"] == "Tool" then
		InfoDescription.Text = string.format("<i>%s</i> <b> <br /> <font color='rgb(255,0,0)'> Damage : %d</font></b>", ItemInfo["Description"], ItemInfo["Damage"])
	elseif ItemInfo["Type"] == "Food" then
		InfoDescription.Text = string.format("<i>%s</i> <b> <br /> <font color='rgb(255,0,0)'>  +%d Health</font></b>", ItemInfo["Description"], ItemInfo["HealthAmount"])
	elseif ItemInfo["Type"] == "Drink" then
		InfoDescription.Text = string.format("<i>%s</i> <b> <br /> <font color='rgb(255,0,0)'> +%d Speed</font> <br /> Duration: %d seconds</b>", ItemInfo["Description"], ItemInfo["SpeedBoost"], ItemInfo["EffectDuration"])
	end

	InfoItemName.Text = ItemName
end

function SelectItem(Item)
	if CurrentSelectedItem == Item then return end
	UpdateInfoPanel(Item)
end

for _, Item in ipairs(InventorySlots:GetChildren()) do
	Item.MouseButton1Click:Connect(function()
		SelectItem(Item)
	end)
end

NextArrow.MouseButton1Click:Connect(function() MoveToPage(1) end)
PreviousArrow.MouseButton1Click:Connect(function() MoveToPage(-1) end)

InfoDropButton.MouseButton1Click:Connect(function()
	if not CurrentSelectedItem or not CurrentSelectedItem:GetAttribute("CurrentItem") then return end
	DropItemsEvent:FireServer(CurrentSelectedItem:GetAttribute("CurrentItem"), 1)
	SelectItem(CurrentSelectedItem)
end)

InfoEquipButton.MouseButton1Click:Connect(function()
	if not CurrentSelectedItem or not CurrentSelectedItem:GetAttribute("CurrentItem") then return end
	EquipItemEvent:FireServer(CurrentSelectedItem:GetAttribute("CurrentItem"))
	SelectItem(CurrentSelectedItem)
end)

function UpdateEquipmentSlot(SlotObject)
	local ItemName = Player:GetAttribute(string.format("%sItem", SlotObject.Name))

	SlotObject.Image = ""

	if not SlotObject then return end
	local ItemInfo = ItemDB.Items[ItemName]
	if not ItemInfo then return end

	SlotObject.Image = ItemInfo["Image"]
end

function UpdateEquipment()
	local Slots = EquipmentSlots:GetChildren()
	for _, SlotObject in ipairs(Slots) do
		Player:GetAttributeChangedSignal(string.format("%sItem", SlotObject.Name)):Connect(function()
			UpdateEquipmentSlot(SlotObject)
		end)
		UpdateEquipmentSlot(SlotObject)
		SlotObject.MouseButton1Click:Connect(function()
			UnequipItemEvent:FireServer(SlotObject.Name)
		end)
	end
end

function ToolBarSelect(Ind)
	ToolBarSelectionStroke.Parent = ToolBarSlots[Ind]
end

function ToolBarUpdate(ToolBarSlot)
	ToolBarSlot.Image = ""

	local ItemName = Player:GetAttribute(string.format("ToolBar%s", ToolBarSlot.Name))

	if not ItemName or ItemName == "" then return end

	local ItemInfo = ItemDB.Items[ItemName]
	if not ItemInfo then return end

	ToolBarSlot.Image = ItemInfo["Image"]
end

function SetupToolBar()
	Player:GetAttributeChangedSignal("SelectedToolBarSlot"):Connect(function()
		local Current = Player:GetAttribute("SelectedToolBarSlot")
		ToolBarSelect(Current)
	end)

	for _, ToolBarSlot in ipairs(ToolBarSlots:GetChildren()) do
		Player:GetAttributeChangedSignal(string.format("ToolBar%s", ToolBarSlot.Name)):Connect(function()
			ToolBarUpdate(ToolBarSlot)
		end)
		ToolBarSlot.MouseButton1Click:Connect(function()
			if script.Parent.Visible then -- Check if inventory is open
				UnequipFromToolBar(ToolBarSlot.Name)
			else
				SelectToolBarEvent:FireServer(ToolBarSlot.Name)
			end
		end)
	end
end

function UnequipFromToolBar(slotName)
	local currentItem = Player:GetAttribute("ToolBar" .. slotName)
	if currentItem and currentItem ~= "" then
		UnequipToolBarEvent:FireServer(slotName)
	end
end

function SetUpAddToToolBar()
	for _, Button in ipairs(InfoToolBarButtons:GetChildren()) do
		Button.MouseButton1Click:Connect(function()
			AddToToolBarEvent:FireServer(CurrentSelectedItem:GetAttribute("CurrentItem") or nil, Button.Name)
		end)
	end
end
SetUpAddToToolBar()

LoadPlayerDataEvent.OnClientEvent:Connect(function(Data)
	UpdateItems(Data["Inventory"])
	UpdateEquipment()
	SetupToolBar()

	for i = 1, SlotCount do
		local ToolBarSlot = ToolBarSlots:FindFirstChild(tostring(i))
		if ToolBarSlot then
			ToolBarSlot:SetAttribute("CurrentItem", Player:GetAttribute(string.format("ToolBar%d", i)))
			ToolBarUpdate(ToolBarSlot)
		end
		ToolBarSelect(Data["SelectedToolBarSlot"])
	end
end)

UpdateUIEvent.OnClientEvent:Connect(function(Inventory)
	UpdateItems(Inventory)
end)
